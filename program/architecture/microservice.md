<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. 微服务治理](#1-微服务治理)
  - [1.1. 限流原理（令牌桶）](#11-限流原理令牌桶)
  - [1.2. 熔断 、降级](#12-熔断-降级)
  - [1.3. 链路追踪](#13-链路追踪)
  - [1.4. Hystrix](#14-hystrix)
    - [1.4.1. 线程池和信号量隔离](#141-线程池和信号量隔离)
  - [1.5. 负载均衡策略](#15-负载均衡策略)
  - [1.6. 作为服务注册中心，Eureka 比 Zookeeper 的区别?](#16-作为服务注册中心eureka-比-zookeeper-的区别)
- [2. 微服务监控](#2-微服务监控)
  - [2.1. 监控可视化（grafana）](#21-监控可视化grafana)
  - [2.2. 服务器系统级监控（falcon）](#22-服务器系统级监控falcon)
  - [2.3. 语言层监控（jvm 监控）](#23-语言层监控jvm-监控)
  - [2.4. 中间件层监控](#24-中间件层监控)
  - [2.5. 应用层监控（健康检查，上线，下线等）](#25-应用层监控健康检查上线下线等)
  - [2.6. trace 埋点](#26-trace-埋点)
- [3. 微服务运维](#3-微服务运维)
  - [3.1. 灰度发布](#31-灰度发布)
  - [3.2. CD 自动部署](#32-cd-自动部署)

<!-- /code_chunk_output -->

## 1. 微服务治理

### 1.1. 限流原理（令牌桶）

令牌桶算法的原理是系统会以一个恒定的速度往桶里放入令牌，而如果请求需要被处理，则需要先从桶里获取一个令牌，当桶里没有令牌可取时，则拒绝服务。

### 1.2. 熔断 、降级

1. 熔断机制是应对雪崩效应，当某个微服务不可用或者响应时间太长，会进行服务降级，近而熔断该节点微服务的调用，快速返回错误的响应信息。在 SpringCloud 中是通过 Hystrix 实现，缺省是 5 秒内调用 20 次
2. 服务降级 一般是从整体符合考虑，就是当某个服务熔断之后，服务器将不再被调用，只返回自定义内容
3. EnableHystrix 开启熔断
4. HystrixCommand(fallbackMethod=””) 声明一个失败回滚处理函，超时会回调

### 1.3. 链路追踪

利用 ThreadLocal + spanId 存储，当前节点的 spanId 作为下个节点的父 spanId

### 1.4. Hystrix

#### 1.4.1. 线程池和信号量隔离

- 线程池隔离：对每个 command 创建一个自己的线程池，执行调用。通过线程池隔离来保证不同调用不会相互干扰和每一个调用的并发限制
- 信号量隔热：对每个 command 创建一个自己的计数器，当并发量超过计数器指定值时，直接拒绝。

使用信号量和线程池的一个区别是，信号量没有 timeout 机制。

### 1.5. 负载均衡策略

1. 轮询
   将所有请求，依次分发到每台服务器上，适合服务器硬件相同的场景。
   优点：服务器请求数目相同；
   缺点：服务器压力不一样，不适合服务器配置不同的情况；

2. 随机
   请求随机分配到各台服务器上。
   优点：使用简单；
   缺点：不适合机器配置不同的场景

3. 最少链接
   将请求分配到连接数最少的服务器上（目前处理请求最少的服务器）。
   优点：根据服务器当前的请求处理情况，动态分配；
   缺点：算法实现相对复杂，需要监控服务器请求连接数；

4. Hash（源地址散列）
   根据 IP 地址进行 Hash 计算，得到 IP 地址。
   优点：将来自同一 IP 地址的请求，同一会话期内，转发到相同的服务器；实现会话粘滞。
   缺点：目标服务器宕机后，会话会丢失；

5. 加权
   在轮询，随机，最少链接，Hash 等算法的基础上，通过加权的方式，进行负载服务器分配。
   优点：根据权重，调节转发服务器的请求数目；
   缺点：使用相对复杂；

### 1.6. 作为服务注册中心，Eureka 比 Zookeeper 的区别?

Zookeeper 保证的是 CP, Eureka 则是 AP。

## 2. 微服务监控 & 报警

### 2.1. 监控可视化（grafana）

### 2.2. 服务器系统级监控（falcon，Promethues，美团 cat）

### 2.3. 语言层监控（jvm 监控）

### 2.4. 中间件层监控

### 2.5. 应用层监控（健康检查，上线，下线等）

### 2.6. trace 埋点

## 3. 微服务运维

### 3.1. 灰度发布

### 3.2. CD 自动部署

## 4. 微服务工具箱

服务注册发现：Eurake，Dobbo，Consul，ZooKeeper，Nacos
服务配置：Nacos
服务熔断：Hystrix，resilience4j，Sentinel
网关：Zuul，Spring Cloud Gateway
负载均衡：Ribbon，Feign
追踪工具：Sleuth，Zipkin，Htrace，Skywalking
日志采集：ELK
监控平台：Promethues，Kibana，grafna，美团 CAT
