# 微服务

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [微服务](#微服务)
  - [限流、熔断 、降级](#限流-熔断-降级)
  - [Hystrix](#hystrix)
    - [线程池和信号量隔离](#线程池和信号量隔离)
  - [负载均衡策略](#负载均衡策略)
  - [作为服务注册中心，Eureka 比 Zookeeper 的区别?](#作为服务注册中心eureka-比-zookeeper-的区别)

<!-- /code_chunk_output -->

## 限流、熔断 、降级

1. 熔断机制是应对雪崩效应，当某个微服务不可用或者响应时间太长，会进行服务降级，近而熔断该节点微服务的调用，快速返回错误的响应信息。在 SpringCloud 中是通过 Hystrix 实现，缺省是 5 秒内调用 20 次
2. 服务降级 一般是从整体符合考虑，就是当某个服务熔断之后，服务器将不再被调用，只返回自定义内容
3. EnableHystrix 开启熔断
4. HystrixCommand(fallbackMethod=””) 声明一个失败回滚处理函，超时会回调

## Hystrix

### 线程池和信号量隔离

- 线程池隔离：对每个 command 创建一个自己的线程池，执行调用。通过线程池隔离来保证不同调用不会相互干扰和每一个调用的并发限制
- 信号量隔热：对每个 command 创建一个自己的计数器，当并发量超过计数器指定值时，直接拒绝。

使用信号量和线程池的一个区别是，信号量没有 timeout 机制。

## 负载均衡策略

1. 轮询
   将所有请求，依次分发到每台服务器上，适合服务器硬件相同的场景。
   优点：服务器请求数目相同；
   缺点：服务器压力不一样，不适合服务器配置不同的情况；

2. 随机
   请求随机分配到各台服务器上。
   优点：使用简单；
   缺点：不适合机器配置不同的场景

3. 最少链接
   将请求分配到连接数最少的服务器上（目前处理请求最少的服务器）。
   优点：根据服务器当前的请求处理情况，动态分配；
   缺点：算法实现相对复杂，需要监控服务器请求连接数；

4. Hash（源地址散列）
   根据 IP 地址进行 Hash 计算，得到 IP 地址。
   优点：将来自同一 IP 地址的请求，同一会话期内，转发到相同的服务器；实现会话粘滞。
   缺点：目标服务器宕机后，会话会丢失；

5. 加权
   在轮询，随机，最少链接，Hash 等算法的基础上，通过加权的方式，进行负载服务器分配。
   优点：根据权重，调节转发服务器的请求数目；
   缺点：使用相对复杂；

## 作为服务注册中心，Eureka 比 Zookeeper 的区别?

Zookeeper 保证的是 CP, Eureka 则是 AP。
